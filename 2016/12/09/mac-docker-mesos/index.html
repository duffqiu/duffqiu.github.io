<!DOCTYPE html><html lang="zh"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="16 个年头的 IT 老兵，除了销售和老板角色，做过 IT 中的各种角色，游走于架构与产品间。关注 Docker, Mesos 等容器化技术领域的实践。主导的分布式服务框架已经广泛用于唯品会各大核心业务系统，以高性能、低延迟广受好评。现任唯品会( VIP.COM )基础架构部分布式服务框架、定时任务调度系统以及容器化管理平台产品经理。"><title>以Docker容器玩转Mesos和Marathon | 了哥(Duff)的博客</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.2.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.0.0/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">以Docker容器玩转Mesos和Marathon</h1><a id="logo" href="/.">了哥(Duff)的博客</a><p class="description">游走于产品与架构间，微信号：duffqiu</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Start</i></a><a href="/archives/"><i class="fa fa-archive"> Archiv</i></a><a href="/about/"><i class="fa fa-user"> Über</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">以Docker容器玩转Mesos和Marathon</h1><div class="post-meta">Dec 9, 2016<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="post-content"><p>感谢各位已经关注我的微信公众号（VIPDOCKER）的同学，正是你们的鼓励让我能继续坚持写下来，如果还没有关注，欢迎你的加入！新近公众被赋予了原创公众号权限，大家可以直接在文章末尾留言了，欢迎任何建议，谢谢！</p>
<h3 id="写在前面的话"><a href="#写在前面的话" class="headerlink" title="写在前面的话"></a>写在前面的话</h3><p>经历了好几个月起起伏伏，我们团队开发的基于<a href="https://github.com/dangdangdotcom/elastic-job" target="_blank" rel="external">Dangdang Elastic Job</a>的分布式调度系统／平台终于成功开源了，开源地址<a href="https://github.com/vipshop/Saturn" target="_blank" rel="external">Saturn</a>。如果需要加入我们的开源微信群，请联系群主：微信号 duffqiu</p>
<h3 id="人生在于折腾"><a href="#人生在于折腾" class="headerlink" title="人生在于折腾"></a>人生在于折腾</h3><p>身为技术人，折腾技术是人生的一种乐趣，也是一种挑战。上次看老肖为了能更便利的安装Mesos做了个开源项目<a href="https://github.com/Dataman-Cloud/crane" target="_blank" rel="external">Crane</a>深有感触。不过这个方式是否还是太重了呢？既然技术上都是玩容器的，那么为什么不直接通过容器的方式来折腾Mesos集群呢？当然只是个人测试环境，不要考虑用到生产上啊。</p>
<p>我用的是Mac，所以就想用docker声称的”Native”的docker来快速安装一套Mesos集群。而不是使用虚拟机的方式来做，因为哪样和Linux搭建没啥区别了。谁知道，还是真的不少坑，弄了两天才搞定。自己都觉得有点丢人了。</p>
<p>下面总结一下是如何做的，希望你不用这么折腾就能在Mac上玩转Mesos，同时也不用安装一堆的应用工具如VirtualBox等。我已经将我自己机器的VirtualBox给删除了，因为没有磁盘空间了。</p>
<p>虽然是Mac下测试的，但是既然是以容器的方式启动，对于Linxu和Windows下原理是一样。</p>
<p>后面这些步骤，希望你能在电脑前一步一步参照去做，而不是只是读这个文章。现在太多文章是只能读读，这些没有太多作用。我还是希望技术类的文章真正能帮到大家去操作的。</p>
<h3 id="折腾一：Mesosphere的基础镜像坑"><a href="#折腾一：Mesosphere的基础镜像坑" class="headerlink" title="折腾一：Mesosphere的基础镜像坑"></a>折腾一：Mesosphere的基础镜像坑</h3><p>折腾一个可以测试／试用的Mesos环境是为了测试一下Mesos新版本的unitified container的功能，但是在使用中就发现了，Mesosphere打Mesos Slave的Image中竟然没有<code>curl</code>命令，但是不知道为什么Mesos会直接使用curl的方式来拉取镜像Image。（据说会改掉，这个方式太low了）所以在开始搭建环境之前，想将mesosphere的Mesos Slave的Image补充curl命令</p>
<h4 id="需要的镜像和版本"><a href="#需要的镜像和版本" class="headerlink" title="需要的镜像和版本"></a>需要的镜像和版本</h4><ul>
<li>Zookeeper: latest版本就可</li>
<li>Mesos Master: 1.1.0-2.0.107.ubuntu1404</li>
<li>Mesos Slave: 1.1.0-2.0.107.ubuntu1404</li>
<li>Marathon: v1.3.6</li>
</ul>
<p>如果需要拉这些Image，最好用国内的代理镜像仓库，如Daocloud，不过正是因为用了这个代理镜像库，给我造成了另外一个坑。后面讲</p>
<h4 id="打包自己的Mesos-Slave镜像"><a href="#打包自己的Mesos-Slave镜像" class="headerlink" title="打包自己的Mesos Slave镜像"></a>打包自己的Mesos Slave镜像</h4><p>前面讲了，需要给Slave镜像补个<code>CURL</code>命令，对应的Dockerfile为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">FROM mesosphere/mesos-slave:1.1.0-2.0.107.ubuntu1404</div><div class="line">MAINTAINER duffqiu@gmail.com</div><div class="line"></div><div class="line">RUN apt-get update &amp;&amp; apt-get install -y curl &amp;&amp; apt-get clean</div></pre></td></tr></table></figure>
<p>然后运行命令打包： <code>docker build -t mesos-slave .</code></p>
<p>后面就使用这个包而不是mesosphere的官方包来运行。不过还是得吐槽下Mesosphere，做为容器生态体系的领军公司，这个容器image打的实在是不够水平。</p>
<h3 id="折腾二：-Docker-Registry的国内代理DaoCloud不用HTTPS"><a href="#折腾二：-Docker-Registry的国内代理DaoCloud不用HTTPS" class="headerlink" title="折腾二： Docker Registry的国内代理DaoCloud不用HTTPS"></a>折腾二： Docker Registry的国内代理DaoCloud不用HTTPS</h3><p>搭建环境的目的是测试<code>Unitified Container</code>，它有个最大的优势是直接支持Docker Image，只需Slave启动的时候配置Registry的地址就可以使用镜像的国内代理地址(启动需要的参数：<code>MESOS_DOCKER_REGISTRY</code>)，原本挺好的设计，谁知道这里也有个坑，一点文档都没有。那就是它默认使用的是<code>HTTPS</code>传输，但是我一开始使用的是daocloud的代理库，它是http的最后造成拉包总是不成功。后来在Yu jie@Mesosphere的指导下，才知道，目前Mesos的实现是如果需要用http，则需要在配置url后面加上80端口。如果你用的私用仓库不是80端口，那么没有办法，因为Mesos还没支持类似Docker daemon那样的<code>insecure-registry</code>配置。所以最后在网上找了个阿里的registry地址来测试。估计这个地址的流量要猛涨了。-:)</p>
<p>另外需要提示一点，就是用容器启动Mesos，对应的官方文档对应的配置参数，都可以用环境变量的方式配置，对应环境变量名的规则是MESOS_<config name="">，都要是全大写。如上面的registry的配置，启动参数是<code>--docker_registry</code>，而环境变量是<code>MESOS_DOCKER_REGISTRY</code></config></p>
<h3 id="折腾三：-Mac下的’Native’-Docker不是’Native’"><a href="#折腾三：-Mac下的’Native’-Docker不是’Native’" class="headerlink" title="折腾三： Mac下的’Native’ Docker不是’Native’"></a>折腾三： Mac下的’Native’ Docker不是’Native’</h3><p>一开始就被Docker的官方文档误导了，以为‘Native’就真的是类似Linux支持哪样，直接使用了Mac的能力来做Docker。好在jason@uber指导了一下，豁然开朗。其实Mac Native还是有VM的，只是从用户体验上让你感觉不到而已，对此相对于Mesos，还是要为Docker的用户体验点个赞。就像你在Mac下找不到docker daemon一样。其实docker daemon还是真实存在。但是这个docker daemon配置已经被hardcode了，你没法更改。同时有个问题，在Mac下这个VM占用的空间会一直增大，无论你是否删除了docker image。这个文件存放在<code>/Users/macbook/Library/Containers/com.docker.docker/Data/com.docker.driver.amd64-linux/Docker.qcow2</code>。之前犯了个低级错误，将这个文件一下子扩大了10G，而我的Mac的硬盘又小，害我一直要删文件腾空间。</p>
<h4 id="Docker-Build占空间"><a href="#Docker-Build占空间" class="headerlink" title="Docker Build占空间"></a>Docker Build占空间</h4><p>Docker build会将Dockerfile所在的目录下的内容都装载进来后才开始打包。所以千万千万要给Dockerfile一个独立的目录。不然就会像我一样无端将Mac下虚拟机扩大了10G空间。</p>
<h4 id="Hack-Mac-Docker’s-VM"><a href="#Hack-Mac-Docker’s-VM" class="headerlink" title="Hack Mac Docker’s VM"></a>Hack Mac Docker’s VM</h4><p>虽然Mac下的Docker还是用的虚拟机的方式，那么如何进入这个虚拟机呢？可以使用以下方式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">docker run -it --rm --privileged --pid=host --net=host -v /:/rootfs --entrypoint=/bin/sh alpine</div><div class="line">cd /rootfs</div><div class="line">chroot /rootfs</div></pre></td></tr></table></figure>
<ul>
<li>首先将虚拟机的根目录mount给一个容器。这里就是一个理解的坑，我一直以为Mac是native的，所以主机的目录就是Mac的目录，其实不是，而是说主机目录其实是虚拟机的目录</li>
<li>用chroot的方式，在虚拟机的根目录为根运行，这样就相当于在虚拟机中了(注意，不是完备的虚拟机能力，如网络等)</li>
</ul>
<p>这个时候，你就可以查找出dockerd的进程了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ps -ef|grep dockerd</div></pre></td></tr></table></figure>
<p>可以看到对应的dockerd的运行参数，这也就解释了为什么Mac下的docker不能配置tcp端口了，因为这个已经被这个VM的配置写死了，而且还改不了。（如何有任何方式可以改，请留言告诉我）以下是Mac的dockerd的启动命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/bin/dockerd --pidfile=/run/docker.pid -H unix:///var/run/docker.sock --swarm-default-advertise-addr=eth0 --debug --storage-driver aufs</div></pre></td></tr></table></figure>
<p>同时可以查看这个虚拟机的磁盘情况，这里就比较清晰展示哪些是VM的磁盘，哪些是Mac的磁盘了。同时，也可以看见，docker用的VM是开了50几G的动态空间的，默认可以最大占用主机50几G的，这个大家一定要注意，不然哪天机器没有磁盘空间了都不知道用到那里去了。后续如果需要清理这些空间，只能卸载Docker再装一次。</p>
<p><img src="/images/mac-vm-disk.png" alt="docker vm disk"></p>
<h4 id="提供Mac-Docker的TCP以及Portainer"><a href="#提供Mac-Docker的TCP以及Portainer" class="headerlink" title="提供Mac Docker的TCP以及Portainer"></a>提供Mac Docker的TCP以及Portainer</h4><p>最近通过阅读微信文章，找到一个本机管理Docker Daemon的一个好的带界面的Container: <a href="http://portainer.io" target="_blank" rel="external">portainer/portainer</a>，可能需要翻墙。但是这个需要通过tcp的方式链接docker dameon，所以需要想个办法将Mac下的unix socket转为TCP。这个可以使用socat工具。Mac下可以通过port工具安装，不过最好还是翻墙安装，不然又是一个折磨。<br>socat的用法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">socat TCP-LISTEN:2375,range=192.168.31.254/32,reuseaddr,fork UNIX-CLIENT:/var/run/docker.sock</div></pre></td></tr></table></figure>
<p>然后启动portainer:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run -d  -p 9000:9000 --restart always portainer/portainer -H tcp://192.168.31.254:2375</div></pre></td></tr></table></figure>
<p><code>192.168.31.254</code>是你的机器ip，需要根据你的实际情况替换</p>
<p>这里需要注意的是，不要使用127.0.0.1的方式链接docker，因为在portainer里的127.0.0.1不是主机的127.0.0.1<br>下面是portainer的一个界面预览，还是相当清爽的，值得使用<br><img src="/images/portainer.png" alt="portainer"></p>
<p>另外可以在Mesos的集群的每个Slave主机上装个这个容器，然后在集群的管理系统中嵌套改页面，这样就可以监控和管理主机的容器／Image等了。同时它还提供了WEB Terminal，可以直接进入容器，方便调试，非常好用。</p>
<p>到此，之前遇到的坑都列举出来了，我们正是开始进入正题，安装Mesos+Marathon集群</p>
<h3 id="Mesos-Marthon集群搭建"><a href="#Mesos-Marthon集群搭建" class="headerlink" title="Mesos+Marthon集群搭建"></a>Mesos+Marthon集群搭建</h3><h4 id="Zookeeper容器化搭建"><a href="#Zookeeper容器化搭建" class="headerlink" title="Zookeeper容器化搭建"></a>Zookeeper容器化搭建</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run --name zookeeper --restart always -d -p 2181:2181 -p 2888:2888 -p 3888:3888 zookeeper</div></pre></td></tr></table></figure>
<p>启动单机版本的Zookeeper，如果需要保留Zookeeper的数据以备下次启动继续使用，则必须将zookeeper的data路径放到主机的目录下，这个具体就不详细描述了。</p>
<p><code>telnet 10.100.150.22 2181</code> 连接到Zookeeper，并输入<code>stat</code>来验证是否安装正确。</p>
<h4 id="Mesos-Master容器化搭建"><a href="#Mesos-Master容器化搭建" class="headerlink" title="Mesos Master容器化搭建"></a>Mesos Master容器化搭建</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">docker run -d -p 5050:5050 \</div><div class="line">  -e MESOS_PORT=5050 \</div><div class="line">  -e MESOS_ZK=zk://192.168.31.254:2181/mesos \</div><div class="line">  -e MESOS_QUORUM=1 \</div><div class="line">  -e MESOS_REGISTRY=in_memory \</div><div class="line">  -e MESOS_LOG_DIR=/var/log/mesos \</div><div class="line">  -e MESOS_WORK_DIR=/var/tmp/mesos \</div><div class="line">  -e MESOS_HOSTNAME=192.168.31.254 \</div><div class="line">mesosphere/mesos-master:1.1.0-2.0.107.ubuntu1404</div></pre></td></tr></table></figure>
<p>这里有一点需要注意：需要设置MESOS_HOSTNAME为你主机的ip地址（例子是我的机器ip，你需要根据实际情况替换），不然打开 <a href="http://127.0.0.1:5050/" target="_blank" rel="external">Mesos Master</a>地址的时候总是不稳定。</p>
<p>只要能打开mesos的UI地址，并且能在界面打得开LOG则证明安装成功了。</p>
<h4 id="Mesos-Slave容器化搭建"><a href="#Mesos-Slave容器化搭建" class="headerlink" title="Mesos Slave容器化搭建"></a>Mesos Slave容器化搭建</h4><h5 id="启动第一台Slave"><a href="#启动第一台Slave" class="headerlink" title="启动第一台Slave"></a>启动第一台Slave</h5><p>这里就需要用到我之前提的自己打包的Mesos Slave镜像了，因为需要用到CURL命令来启动Unified Container。同时我也希望Slave能够同时使用Docker Container或者Mesos Container。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">docker run -d --privileged -p 5051:5051 \</div><div class="line">  -v /usr/bin/docker:/usr/bin/docker \</div><div class="line">  -v /var/run/docker.sock:/var/run/docker.sock \</div><div class="line">  -v /sys/fs/cgroup:/sys/fs/cgroup \</div><div class="line">  -e MESOS_PORT=5051 \</div><div class="line">  -e MESOS_MASTER=zk://172.17.0.3:2181/mesos \</div><div class="line">  -e MESOS_SWITCH_USER=0 \</div><div class="line">  -e MESOS_CONTAINERIZERS=mesos,docker \</div><div class="line">  -e MESOS_LOG_DIR=/var/log/mesos \</div><div class="line">  -e MESOS_WORK_DIR=/var/tmp/mesos \</div><div class="line">  -e MESOS_IMAGE_PROVIDERS=docker \</div><div class="line">  -e MESOS_ISOLATION=filesystem/linux,docker/runtime \</div><div class="line">  -e MESOS_DOCKER_REGISTRY=https://r6w9c7qa.mirror.aliyuncs.com \</div><div class="line">  -e MESOS_ADVERTISE_IP=192.168.31.254 \</div><div class="line">  -e MESOS_ADVERTISE_PORT=5051 \</div><div class="line">  -e GLOG_v=1 \</div><div class="line">mesos-slave</div></pre></td></tr></table></figure>
<p>这里有几点注意点：</p>
<ul>
<li>如果需要用docker container，需要将-v的这几个盘挂载到容器中。注意，这里的主机盘地址是VM的地址，不是Mac主机的地址</li>
<li><code>MESOS_MASTER</code>配置可以直接写Mesos Master的http地址就可，不用连接Zookeeper了。或许这样可以减轻Zookeeper的压力。不过依然可以使用zookeeper的方式链接。这里的地址使用容器间的地址就可。不过文档没有说如果是配置Master的http地址的话，如何支持多台Mesos地址。（据说目前http方式只能用于测试，生产的话要用zk的链接，因为zk支持多个服务器配置）</li>
<li><code>MESOS_CONTAINERIZERS</code>需要指明mesos和docker，这样才可以运行docker container以及mesos container</li>
<li><code>IMAGE_PROVIDERS</code> 指明都是用docker镜像，这个是给Mesos container用的</li>
<li><code>MESOS_ISOLATION</code> 使用Mesos Container，则必须制定这两个隔离器</li>
<li><code>MESOS_DOCKER_REGISTRY</code> 指明用Unified Container需要的docker image的拉取地址。注意我前面提到的坑。这个和docker container没有关系</li>
<li><code>MESOS_ADVERTISE_IP</code>和<code>MESOS_ADVERTISE_PORT</code>公开对外的ip和对外的port。如果不是用这个，在容器部署里，无法在Mesos master上获取到agent的log</li>
<li>这里不要设置<code>MESOS_HOSTNAME</code>，因为设置了就无法在界面看见agent的LOG了</li>
</ul>
<h5 id="启动第二台Slave"><a href="#启动第二台Slave" class="headerlink" title="启动第二台Slave"></a>启动第二台Slave</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">docker run -d --privileged -p 5052:5051 \</div><div class="line">  -v /usr/bin/docker:/usr/bin/docker \</div><div class="line">  -v /var/run/docker.sock:/var/run/docker.sock \</div><div class="line">  -v /sys/fs/cgroup:/sys/fs/cgroup \</div><div class="line">  -e MESOS_PORT=5051 \</div><div class="line">  -e MESOS_MASTER=zk://172.17.0.3:2181/mesos \</div><div class="line">  -e MESOS_SWITCH_USER=0 \</div><div class="line">  -e MESOS_CONTAINERIZERS=mesos,docker \</div><div class="line">  -e MESOS_LOG_DIR=/var/log/mesos \</div><div class="line">  -e MESOS_WORK_DIR=/var/tmp/mesos \</div><div class="line">  -e MESOS_IMAGE_PROVIDERS=docker \</div><div class="line">  -e MESOS_ISOLATION=filesystem/linux,docker/runtime \</div><div class="line">  -e MESOS_DOCKER_REGISTRY=https://r6w9c7qa.mirror.aliyuncs.com \</div><div class="line">  -e MESOS_ADVERTISE_IP=192.168.31.254 \</div><div class="line">  -e MESOS_ADVERTISE_PORT=5052 \</div><div class="line">  -e GLOG_v=1 \</div><div class="line">mesos-slave</div></pre></td></tr></table></figure>
<p>在同一台机器启动多个Slave，这里只需要更改暴露的端口就可以了</p>
<h4 id="部署Marathon"><a href="#部署Marathon" class="headerlink" title="部署Marathon"></a>部署Marathon</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run -d -p 8080:8080 mesosphere/marathon:v1.3.6 --master zk://172.17.0.3:2181/mesos --zk zk://172.17.0.3:2181/marathon</div></pre></td></tr></table></figure>
<p>然后在Mac主机访问 <a href="http://127.0.0.1:8080/ui/#/apps" target="_blank" rel="external">Marathon UI</a>就可</p>
<h4 id="Marathon启动容器"><a href="#Marathon启动容器" class="headerlink" title="Marathon启动容器"></a>Marathon启动容器</h4><h5 id="启动一个Docker的容器"><a href="#启动一个Docker的容器" class="headerlink" title="启动一个Docker的容器"></a>启动一个Docker的容器</h5><p>通过界面配置的方式启动一个docker容器应用，对应的json为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;id&quot;: &quot;testapp&quot;,</div><div class="line">  &quot;cmd&quot;: &quot; while true;do echo hello;sleep 1;done&quot;,</div><div class="line">  &quot;cpus&quot;: 1,</div><div class="line">  &quot;mem&quot;: 128,</div><div class="line">  &quot;disk&quot;: 0,</div><div class="line">  &quot;instances&quot;: 1,</div><div class="line">  &quot;container&quot;: &#123;</div><div class="line">    &quot;docker&quot;: &#123;</div><div class="line">      &quot;image&quot;: &quot;centos&quot;,</div><div class="line">      &quot;network&quot;: &quot;BRIDGE&quot;</div><div class="line">    &#125;,</div><div class="line">    &quot;type&quot;: &quot;DOCKER&quot;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>默认Marathon启动的是docker容器。启动后，可以在Mac上<code>docker ps</code>看到这个运行的容器了。</p>
<h5 id="启动一个Docker-Image的Mesos的容器-Unified-Container"><a href="#启动一个Docker-Image的Mesos的容器-Unified-Container" class="headerlink" title="启动一个Docker Image的Mesos的容器(Unified Container)"></a>启动一个Docker Image的Mesos的容器(Unified Container)</h5><p>因为现在Marathon的界面还没有得选择Mesos容器类型，所以需要在JSON模式修改，将之前的JSON配置的type改为<code>MESOS</code>就可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;id&quot;: &quot;mesostest&quot;,</div><div class="line">  &quot;cmd&quot;: &quot;while true;do echo hello docker &gt;&gt; txt.log ;sleep 1;done&quot;,</div><div class="line">  &quot;cpus&quot;: 1,</div><div class="line">  &quot;mem&quot;: 128,</div><div class="line">  &quot;disk&quot;: 0,</div><div class="line">  &quot;instances&quot;: 1,</div><div class="line">  &quot;container&quot;: &#123;</div><div class="line">    &quot;docker&quot;: &#123;</div><div class="line">      &quot;image&quot;: &quot;102010cncger/centos:v1&quot;,</div><div class="line">      &quot;network&quot;: &quot;BRIDGE&quot;</div><div class="line">    &#125;,</div><div class="line">    &quot;type&quot;: &quot;MESOS&quot;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的image名字是因为我随便搜索了个阿里的registry地址，所以要通过<code>curl https://r6w9c7qa.mirror.aliyuncs.com/v2/_catalog</code>获取它存在的镜像名字，然后再通过<code>curl https://r6w9c7qa.mirror.aliyuncs.com//v2/102010cncger/centos/tags/list</code>获取它的tag，从而指导它可用的镜像是<code>102010cncger/centos:v1</code></p>
<p>因为Slave用的是ubuntu，我又不太了解怎么装个nsenter，所以只能用一下方法进入到这个Mesos容器中</p>
<ul>
<li>先用 <code>docker exec -it &lt;slave container id&gt; /bin/bash</code> 从Mac进入到Slave的容器中</li>
<li>用<code>ps -ef |grep mesos-executor</code> 找到mesos executor的执行命令参数，获得容器的具体路径<code>--rootfs</code>那段，如我的例子<code>/var/tmp/mesos/provisioner/containers/dd2a4567-4ad5-4b50-bdee-2351d0b863e8/backends/copy/rootfses/a913d575-9e5f-4384-b4bd-4ed36618f157</code></li>
<li>用chroot的方式进入这个容器: <code>chroot /var/tmp/mesos/provisioner/containers/dd2a4567-4ad5-4b50-bdee-2351d0b863e8/backends/copy/rootfses/a913d575-9e5f-4384-b4bd-4ed36618f157 /bin/bash</code>，这样你就进入mesos的这个容器了的shell，但是无法获取这个容器的其它能力如网络等.</li>
</ul>
<h6 id="使用nsenter"><a href="#使用nsenter" class="headerlink" title="使用nsenter"></a>使用nsenter</h6><p>ubuntu14.04安装nsenter的方式，这里谢谢黄浩松@shopee.sg<br>用docker 容器的方式来安装nsenter，步骤是</p>
<ul>
<li>首先进入到Slave的容器中<code>docker exec -it &lt;slave container id&gt; /bin/bash</code></li>
<li>使用<a href="https://github.com/jpetazzo/nsenter" target="_blank" rel="external">jpetazzo/nsenter</a>这个镜像，但是很奇怪不能用它推荐的<code>docker run --rm -v /usr/local/bin:/target jpetazzo/nsenter</code>，而是要使用导出nsenter的方式<code>docker run --rm jpetazzo/nsenter cat /nsenter &gt; /tmp/nsenter &amp;&amp; chmod +x /tmp/nsenter</code></li>
<li>获得nsenter后，执行<code>nsenter --target $PID --mount --uts --ipc --net --pid /bin/bash</code>进入容器， $PID为容器对应的进程pid，通过<code>ps -ef</code>查看，完整的容器镜像的cmd那个进程id</li>
</ul>
<p>到此Mesos container的安装部署测试完成了。不过这里还是需要吐槽一下Mesos Container，这样启动容器，就算你配置上是<code>&quot;network&quot;: &quot;BRIDGE&quot;</code>，但是如果没有配置CNI，还是没有bridge的，只能是host模式。</p>
<p>正好我的公众号开通了打赏，看在写的这么幸苦以及亲自验证的份上，请多多支持，赞赏一下吧，谢谢！</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://duffqiu.github.com/2016/12/09/mac-docker-mesos/" data-id="ciwno9xbj004ugiznrobf58sp" class="article-share-link">Aktie</a><div class="tags"><a href="/tags/Docker/">Docker</a><a href="/tags/Mac/">Mac</a><a href="/tags/Mesos/">Mesos</a></div><div class="post-nav"><a href="/2016/11/23/mac-vlan-improvement/" class="next">容器网络的Bridge/Vlan模式的演进</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://duffqiu.github.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Kategorien</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Appscale/">Appscale</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Auto-Test/">Auto Test</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Auto-Test/Jenkins/">Jenkins</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Auto-Test/Jenkins/JUnit/">JUnit</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/CentOS/">CentOS</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/CentOS/VirtualBox/">VirtualBox</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/CoreOS/">CoreOS</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/CoreOS/ETCD2/">ETCD2</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/CoreOS/Fleet/">Fleet</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/CoreOS/Keepalived/">Keepalived</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/CoreOS/ZSH/">ZSH</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Design-Pattern/">Design Pattern</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Design-Pattern/Java/">Java</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Design-Pattern/Java/Guava/">Guava</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Entity-Model/">Entity Model</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Entity-Model/Data-Model/">Data Model</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Integration/">Integration</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/Design-Pattern/">Design Pattern</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/Guice/">Guice</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/OO/">OO</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/Scala/">Scala</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/Scala/Maven/">Maven</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Jenkins/">Jenkins</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Jenkins/Findbugs/">Findbugs</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/MAC/">MAC</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/MAC/Docker/">Docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/MAC/OSX/">OSX</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Maven/">Maven</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Maven/PlantUML/">PlantUML</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Miscellany/">Miscellany</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Miscellany/Appscale/">Appscale</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Miscellany/Appscale/Docker/">Docker</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/OSX/">OSX</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/OSX/MAC/">MAC</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/OSX/Port/">Port</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Octopress/">Octopress</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Octopress/Bing/">Bing</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Octopress/GSL/">GSL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Octopress/Jekyll/">Jekyll</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Octopress/PlantUML/">PlantUML</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Openstack/">Openstack</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Openstack/Block-Storage/">Block Storage</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Openstack/Keepalived/">Keepalived</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/PlantUML/">PlantUML</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Port/">Port</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Proxy/">Proxy</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Proxy/Linux/">Linux</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/REST/">REST</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SBT/">SBT</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/SBT/Jenkins/">Jenkins</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Scala/">Scala</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Scala/FP/">FP</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Scala/SBT/">SBT</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Scala/Script/">Script</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Sublime/">Sublime</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Sublime/Scala/">Scala</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Systemd/">Systemd</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/UML/">UML</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Virtualbox/">Virtualbox</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Virtualbox/Centos/">Centos</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Virtualbox/Centos/NFS/">NFS</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Zookeeper/">Zookeeper</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Zookeeper/Cloud/">Cloud</a></li></ul></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/tags/Scrum/" style="font-size: 15px;">Scrum</a> <a href="/tags/Weixin/" style="font-size: 15px;">Weixin</a> <a href="/tags/Mac/" style="font-size: 15px;">Mac</a> <a href="/tags/Mesos/" style="font-size: 15px;">Mesos</a> <a href="/tags/Network/" style="font-size: 15px;">Network</a> <a href="/tags/Shrike/" style="font-size: 15px;">Shrike</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Letzte</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/12/09/mac-docker-mesos/">以Docker容器玩转Mesos和Marathon</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/23/mac-vlan-improvement/">容器网络的Bridge/Vlan模式的演进</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/15/weixin-commercial-mode/">YY一下微信公众号的商业模式</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/11/scrum-practice-at-vip-4/">唯品会敏捷Scrum实践历程总结(四)</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/31/scrum-practice-at-vip-3/">唯品会敏捷Scrum实践历程总结(三)</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/22/scrum-practice-at-vip-2/">唯品会敏捷Scrum实践历程总结(二)</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/19/scrum-practice-at-vip/">在唯品会做敏捷Scrum的历程总结(一)</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/11/docker-image-layout/">Docker镜像分层的注意点</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/14/docker-network-isolation/">Docker网络隔离初步设想</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/10/dockerde-vlan/">Docker的VLAN网络模式配置</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Blogroll</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">了哥(Duff)的博客.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>